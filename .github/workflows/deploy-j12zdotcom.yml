name: Deploy j12zdotcom to Mimosa

# Ce workflow dÃ©ploie automatiquement le site j12zdotcom sur le serveur mimosa
# DÃ©clenchÃ© manuellement ou via webhook depuis le repo j12zdotcom

on:
  # DÃ©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      skip_nix_rebuild:
        description: 'Skip NixOS rebuild (only update site files)'
        required: false
        default: 'false'
        type: boolean

  # DÃ©clenchement via webhook (depuis le repo j12zdotcom)
  repository_dispatch:
    types: [deploy-site]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout j12zdotcom repository
        uses: actions/checkout@v4
        with:
          repository: JeremieAlcaraz/j12zdotcom
          ref: main  # ou 'master' selon ta branche par dÃ©faut

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ğŸ“š Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ—„ï¸ Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build site
        run: pnpm build
        env:
          NODE_ENV: production

      - name: ğŸ“Š Build info
        run: |
          echo "Build completed successfully!"
          echo "Files built: $(find dist -type f | wc -l)"
          echo "Total size: $(du -sh dist | cut -f1)"
          echo "Commit: $(git rev-parse --short HEAD)"

      - name: ğŸ“¦ Create deployment archive
        run: |
          tar -czf site.tar.gz -C dist .
          echo "Archive size: $(du -sh site.tar.gz | cut -f1)"

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: j12zdotcom-dist
          path: site.tar.gz
          retention-days: 7
          compression-level: 0  # Already compressed

      - name: ğŸ” Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.MIMOSA_SSH_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to Mimosa
        env:
          MIMOSA_HOST: ${{ secrets.MIMOSA_HOST }}
          SKIP_NIX: ${{ inputs.skip_nix_rebuild || 'false' }}
        run: |
          set -euo pipefail

          echo "ğŸŒ Deploying to $MIMOSA_HOST..."

          # Upload archive
          echo "ğŸ“¤ Uploading site archive..."
          scp site.tar.gz "$MIMOSA_HOST:/tmp/j12zdotcom-deploy.tar.gz"

          # Extract and deploy on remote
          echo "ğŸ“¦ Extracting and deploying..."
          ssh "$MIMOSA_HOST" << 'ENDSSH'
            set -euo pipefail

            # Backup current site
            if [ -d /var/www/j12zdotcom ]; then
              BACKUP="/var/www/j12zdotcom.backup.$(date +%Y%m%d-%H%M%S)"
              echo "ğŸ’¾ Backing up to $BACKUP"
              sudo cp -r /var/www/j12zdotcom "$BACKUP"
              # Keep only last 3 backups
              ls -dt /var/www/j12zdotcom.backup.* 2>/dev/null | tail -n +4 | xargs -r sudo rm -rf
            fi

            # Deploy new site
            echo "ğŸ”„ Deploying new version..."
            sudo mkdir -p /var/www/j12zdotcom
            sudo rm -rf /var/www/j12zdotcom/*

            # Extract
            cd /var/www/j12zdotcom
            sudo tar -xzf /tmp/j12zdotcom-deploy.tar.gz

            # Set permissions
            sudo chown -R root:root /var/www/j12zdotcom
            sudo chmod -R 755 /var/www/j12zdotcom

            # Cleanup
            rm /tmp/j12zdotcom-deploy.tar.gz

            echo "âœ… Site deployed successfully"
            echo "ğŸ“Š Files deployed: $(find /var/www/j12zdotcom -type f | wc -l)"
          ENDSSH

          # Rebuild NixOS if requested
          if [ "$SKIP_NIX" = "false" ]; then
            echo "ğŸ”„ Rebuilding NixOS configuration..."
            ssh "$MIMOSA_HOST" "cd /etc/nixos && sudo nixos-rebuild switch --flake '.#mimosa' --impure"
            echo "âœ… NixOS rebuild complete"
          else
            echo "â­ï¸  Skipping NixOS rebuild"
          fi

      - name: ğŸ” Health checks
        env:
          MIMOSA_HOST: ${{ secrets.MIMOSA_HOST }}
        run: |
          echo "ğŸ¥ Running health checks..."

          # Check services
          ssh "$MIMOSA_HOST" << 'ENDSSH'
            if systemctl is-active --quiet caddy; then
              echo "âœ… Caddy is running"
            else
              echo "âŒ Caddy is not running!"
              exit 1
            fi

            if systemctl is-active --quiet cloudflared; then
              echo "âœ… Cloudflared is running"
            else
              echo "âŒ Cloudflared is not running!"
              exit 1
            fi

            # Test HTTP endpoint
            if curl -sf http://localhost > /dev/null; then
              echo "âœ… HTTP endpoint responding"
            else
              echo "âŒ HTTP endpoint not responding!"
              exit 1
            fi
          ENDSSH

          # Test public HTTPS
          if curl -sf https://jeremiealcaraz.com > /dev/null; then
            echo "âœ… Public HTTPS site responding"
          else
            echo "âš ï¸  Public site not responding (may take a few seconds)"
          fi

      - name: ğŸ“ Deployment summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Repository: JeremieAlcaraz/j12zdotcom"
          echo "ğŸ”– Commit: $(git rev-parse --short HEAD)"
          echo "ğŸŒ Public URL: https://jeremiealcaraz.com"
          echo "â° Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ’¬ Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs above for details."
          exit 1
