name: Update n8n next version

on:
  schedule:
    # Tous les jours Ã  2h du matin (UTC)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Permet dÃ©clenchement manuel

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current n8n image
        id: current
        run: |
          # Extraire l'image actuelle depuis n8n.nix
          CURRENT_IMAGE=$(grep -oP 'image = "docker.io/n8nio/n8n:\K[^"]+' hosts/whitelily/n8n.nix)
          echo "image=$CURRENT_IMAGE" >> $GITHUB_OUTPUT
          echo "Current image: docker.io/n8nio/n8n:$CURRENT_IMAGE"

          # Si l'image contient dÃ©jÃ  un digest SHA256, l'extraire
          if [[ "$CURRENT_IMAGE" == *"@sha256:"* ]]; then
            CURRENT_DIGEST=$(echo "$CURRENT_IMAGE" | grep -oP '@sha256:\K[a-f0-9]+')
          else
            CURRENT_DIGEST="none"
          fi
          echo "digest=$CURRENT_DIGEST" >> $GITHUB_OUTPUT
          echo "Current digest: $CURRENT_DIGEST"

      - name: Get latest n8n:next digest from Docker Hub
        id: latest
        run: |
          echo "Fetching latest n8n:next digest from Docker Hub..."

          # Obtenir un token d'authentification Docker Hub
          TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:n8nio/n8n:pull" | jq -r .token)

          # RÃ©cupÃ©rer le digest depuis le header Docker-Content-Digest
          # Cette mÃ©thode est plus fiable que de parser le manifest JSON
          LATEST_DIGEST=$(curl -sI -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
            "https://registry-1.docker.io/v2/n8nio/n8n/manifests/next" \
            | grep -i "docker-content-digest:" \
            | cut -d' ' -f2 \
            | tr -d '\r' \
            | cut -d: -f2)

          echo "digest=$LATEST_DIGEST" >> $GITHUB_OUTPUT
          echo "Latest n8n:next digest: sha256:$LATEST_DIGEST"

      - name: Extract n8n version from image
        id: version
        run: |
          echo "Extracting n8n version from image labels..."

          # Obtenir un token d'authentification
          TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:n8nio/n8n:pull" | jq -r .token)

          # RÃ©cupÃ©rer le manifest (peut Ãªtre une liste de manifests)
          MANIFEST=$(curl -s -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
            "https://registry-1.docker.io/v2/n8nio/n8n/manifests/next")

          # VÃ©rifier si c'est une manifest list (multi-arch)
          MANIFEST_TYPE=$(echo "$MANIFEST" | jq -r '.mediaType // .schemaVersion')
          echo "Manifest type: $MANIFEST_TYPE"

          # Si c'est une manifest list, rÃ©cupÃ©rer le manifest pour linux/amd64
          if echo "$MANIFEST" | jq -e '.manifests' > /dev/null 2>&1; then
            echo "Multi-arch manifest detected, selecting linux/amd64..."
            AMD64_DIGEST=$(echo "$MANIFEST" | jq -r '.manifests[] | select(.platform.architecture=="amd64" and .platform.os=="linux") | .digest')
            echo "AMD64 manifest digest: $AMD64_DIGEST"

            # RÃ©cupÃ©rer le manifest spÃ©cifique Ã  amd64
            MANIFEST=$(curl -s -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
              "https://registry-1.docker.io/v2/n8nio/n8n/manifests/$AMD64_DIGEST")
          fi

          # Extraire le config digest
          CONFIG_DIGEST=$(echo "$MANIFEST" | jq -r '.config.digest')
          echo "Config digest: $CONFIG_DIGEST"

          if [ "$CONFIG_DIGEST" == "null" ] || [ -z "$CONFIG_DIGEST" ]; then
            echo "Warning: Could not extract config digest, using fallback"
            VERSION="next"
          else
            # RÃ©cupÃ©rer le config blob qui contient les labels
            CONFIG=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "https://registry-1.docker.io/v2/n8nio/n8n/blobs/$CONFIG_DIGEST")

            # Extraire la version depuis les labels (essayer diffÃ©rents labels possibles)
            VERSION=$(echo "$CONFIG" | jq -r '.config.Labels["org.opencontainers.image.version"] // .config.Labels["version"] // "next"')
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "n8n version: $VERSION"


      - name: Check if update needed
        id: check
        run: |
          CURRENT="${{ steps.current.outputs.digest }}"
          LATEST="${{ steps.latest.outputs.digest }}"

          echo "Comparing digests:"
          echo "  Current: $CURRENT"
          echo "  Latest:  $LATEST"

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "âœ… New version detected! Update needed."
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Already up to date, no update needed."
          fi

      - name: Update n8n.nix with new digest
        if: steps.check.outputs.update_needed == 'true'
        run: |
          LATEST_DIGEST="${{ steps.latest.outputs.digest }}"

          echo "Updating hosts/whitelily/n8n.nix with new digest..."

          # Mise Ã  jour du fichier avec le nouveau digest
          # On remplace l'ancienne ligne image par la nouvelle avec le digest
          sed -i 's|image = "docker.io/n8nio/n8n:.*";.*|image = "docker.io/n8nio/n8n:next@sha256:'"$LATEST_DIGEST"'";  # Tag next pour les derniÃ¨res betas|' hosts/whitelily/n8n.nix

          echo "Updated content:"
          grep "image =" hosts/whitelily/n8n.nix

      - name: Create Pull Request
        if: steps.check.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.N8N_UPDATE_TOKEN }}
          commit-message: "â¬†ï¸ Update n8n to next@sha256:${{ steps.latest.outputs.digest }}"
          branch: update/n8n-next-${{ steps.latest.outputs.digest }}
          delete-branch: true
          title: "â¬†ï¸ Update n8n:next to latest version #${{ steps.version.outputs.version }}"
          body: |
            ## ğŸš€ Automated n8n Update

            A new version of `n8n:next` has been detected on Docker Hub.

            ## ğŸ¯ **Version n8n: `${{ steps.version.outputs.version }}`**

            ### ğŸ“Š Changes

            | Item | Value |
            |------|-------|
            | **n8n Version** | **`${{ steps.version.outputs.version }}`** |
            | **Previous digest** | `${{ steps.current.outputs.digest }}` |
            | **New digest** | `${{ steps.latest.outputs.digest }}` |
            | **Tag** | `next` (beta releases) |
            | **Image** | `docker.io/n8nio/n8n:next` |

            ### ğŸ” What's in this update?

            This PR updates the n8n container to the latest `next` tag version. The `next` tag includes the latest beta features and improvements from n8n.

            ### âœ… Deployment Instructions

            After merging this PR, deploy on whitelily:

            ```bash
            # SSH into whitelily
            ssh jeremie@whitelily

            # Pull the latest config
            cd /root/nix-config
            sudo git pull

            # Rebuild and switch
            sudo nixos-rebuild switch --flake .#whitelily

            # Verify n8n is running
            sudo systemctl status podman-n8n.service
            ```

            ### ğŸ“š Release Notes

            Check n8n release notes and changelog:
            - ğŸ”— [n8n Releases](https://github.com/n8n-io/n8n/releases)
            - ğŸ”— [n8n Changelog](https://docs.n8n.io/changelog/)

            ### ğŸ” Security Note

            The digest (`sha256:...`) ensures image integrity and immutability. The exact same image will be deployed.

            ---

            ğŸ¤– *This PR was automatically created by the [update-n8n-next workflow](.github/workflows/update-n8n-next.yml)*
          labels: |
            dependencies
            automated
            n8n
            enhancement
          assignees: JeremieAlcaraz
